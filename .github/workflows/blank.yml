name: CI
on:
  repository_dispatch:
    types:
      - quick_print
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]  
env:
# game
  # DEFAULT_DDING_SECRET: 'SEC618a0dffd91ebf7db4c9c00e2a82b863bc6181858cadbdbf1655ca6dcd2fd1cc'
  # DEFAULT_DDING_TOKEN: '4e27925ce9df0372171763c071b36bb442cdbf296f315484b9cb165f331da225'
  DEFAULT_DDING_SECRET: 'SECbe4003c4d14c740788cf9383fa1d8d77c029a03e6df99dde528274b9bcc17926'
  DEFAULT_DDING_TOKEN: 'fd87df4f83611b4c4cf31d5ad48f890f9603b57b1cac3d52fb80df8b86a5b629'

concurrency:
  group: build-latest
  cancel-in-progress: true
  
jobs:
  msw-msvs:
    runs-on: windows-${{ matrix.vsversion }}
    name: wxMSW vs${{ matrix.vsversion }} ${{ matrix.configuration }} ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - configuration: 'Release'
            platform: 'x64'
            vsversion: 2022
    steps:

      # Steps represent a sequence of tasks that will be executed as part of the job
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - name: Install dding on non-Windows
        if: runner.os != 'Windows'
        run: |
          pip install certifi
          pip install dding
          mkdir -p ~/.dding
          dding_secret="${{ github.event.client_payload.secret || env.DEFAULT_DDING_SECRET }}"
          dding_token="${{ github.event.client_payload.token || env.DEFAULT_DDING_TOKEN }}"
          cat <<EOF > ~/.dding/config.json
          [
              {
                  "group": "default",
                  "secret": "$dding_secret",
                  "token": "$dding_token"
              }
          ]
          EOF
      
      - name: Install dding on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          pip install certifi
          pip install dding
          New-Item -Path $HOME\.dding -ItemType Directory -Force
          $dding_secret = "${{ github.event.client_payload.secret || env.DEFAULT_DDING_SECRET }}"
          $dding_token = "${{ github.event.client_payload.token || env.DEFAULT_DDING_TOKEN }}"
          $config = @"
          [
              {
                  "group": "default",
                  "secret": "$dding_secret",
                  "token": "$dding_token"
              }
          ]
          "@
          $config | Out-File -FilePath $HOME\.dding\config.json -Encoding utf8
            
      # - name: Set up JDK 8 (OpenJDK)
      #   uses: actions/setup-java@v4
      #   with:
      #     distribution: 'zulu' # 选择OpenJDK发行版，这里用temurin（建议，官方推荐）
      #     java-version: '8'

      # - name: Check Java version
      #   run: java -version

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

          
      - name: Cache SSH known hosts
        id: cache-ssh-hosts
        uses: actions/cache@v3
        with:
          path: ~/.ssh/known_hosts
          key: ssh-known-hosts-${{ runner.os }}-v1
          restore-keys: |
            ssh-known-hosts-${{ runner.os }}-
            
      - name: show payload
        run: |
          echo "Client payload: ${{ toJson(github.event.client_payload) }}"
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      - name: Add Gitee ssh-key to known hosts
        shell: bash
        run: |
          mkdir -p $HOME/.ssh
          cat >$HOME/.ssh/known_hosts <<Eof
            gitee.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDMzG3r+88lWSDK9fyjcZmYsWGDBDmGoAasKMAmjoFloGt9HRQX2Qp4f9FY2XK/hsHYinvoh5Xytl9iaUNUWMfYR8q6VEMtOO87DgoAFcfKZHt0/nbAg9RoNTKYt6v8tPwYpr7N0JP/01nE4LFsNDnstr6H0bXSAzbKWCETLZfdPV4l2uSpRn3bU0ugoZ0aSKz5Dc/IloBfGCTvkSsxUydMRd/Chpjt6VxncDbp+Fa6pzsseK8OQzrg6Fgc5783EN3EQqZ2skqyCwExtx95BJlfx1B3luZnWfpkwNDnrZRT/Qx0OrWqyf0q6f9uQr+UG1S8qDcUn3e/9onq3rwBri8/
            gitee.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMuEoYdx6to5oxR60IWj8uoe1aI0X1fKOHWOtLqTg1tsLT1iFwXV5JmFjU46EzeMBV/6EmI1uaRI6HiEPtPtJHE=
            gitee.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEKxHSJ7084RmkJ4YdEi5tngynE8aZe2uEoVVsB/OvYN
          Eof

      - name: Setup SSH Key
        shell: bash
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts



      # - name: Setup Debug Session
      #   uses: mxschmitt/action-tmate@v3
      #   timeout-minutes: 15
      #   with:
      #     detached: true

      - name: Get current branch name
        shell: bash
        id: get_branch
        run: |
          echo "BRANCH=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_ENV
          echo "BRANCH_NAME=master" >> $GITHUB_ENV
          # echo "UTILS_DIR=${PWD}/${{github.event.client_payload.project_name}}/myutils" >> $GITHUB_ENV
          echo "UTILS_DIR=/tmp/myutils" >> $GITHUB_ENV
          echo "WORK_ROOT_DIR=${PWD}/${{github.event.client_payload.project_name}}" >> $GITHUB_ENV
          echo "WORKSPACE=${PWD}/${{github.event.client_payload.project_name}}" >> $GITHUB_ENV
          echo "JENKINS_ENV_PATH=/tmp/.JENKINS.env" >> $GITHUB_ENV
          # echo "JENKINS_ENV_PATH=${PWD}/${{github.event.client_payload.project_name}}/.JENKINS.env" >> $GITHUB_ENV
          echo "RELEASE_PACKAGE=123.60.164.114" >> $GITHUB_ENV 
          echo "JAVA_SSO_PACKAGE=sso-1.0.1.jar"  >> $GITHUB_ENV
          echo "ISDEBUG=${{github.event.client_payload.isdebug}}" >> $GITHUB_ENV
          

      - name: Generate JENKINS.env
        shell: bash
        run: |
          echo "export BRANCH=$BRANCH " >> $JENKINS_ENV_PATH
          echo "export UTILS_DIR=$UTILS_DIR" >> $JENKINS_ENV_PATH
          echo "export WORK_ROOT_DIR=$WORK_ROOT_DIR" >> $JENKINS_ENV_PATH
          if [ "$ISDEBUG" = "true" ]; then
            echo "============ JENKINS.env Content ============"
            cat $WORK_ROOT_DIR/.JENKINS.env
            echo "============================================="
          fi     
        # working-directory: ./${{ github.event.client_payload.project_name }}
        
      - name: git clone 
        shell: bash
        run: |
          export UTILS_DIR=/tmp/myutils
          git clone git@github.com:charlessoft/myutils.git ${UTILS_DIR}
          pushd .
          echo ${UTILS_DIR}
          cd ${UTILS_DIR}
          source utils.sh
          popd 
          bash /tmp/myutils/quick_print_build/scripts/clone_code.sh ${JENKINS_ENV_PATH} || CheckLastResult


      - name: Generate env 
        shell: bash
        run: |
          export UTILS_DIR=${PWD}/${{github.event.client_payload.project_name}}/myutils
          echo "UTILS_DIR=${PWD}/${{github.event.client_payload.project_name}}/myutils" >> $GITHUB_ENV
          echo "export UTILS_DIR=$UTILS_DIR" >> $JENKINS_ENV_PATH

          
      # - name: build
      #   run: |
      #     pushd .
      #     cd ${UTILS_DIR}
      #     source utils.sh
      #     popd 
      #     bash ${WORKSPACE}/myutils/quick_print_build/scripts/build_server.sh ${JENKINS_ENV_PATH} || CheckLastResult
                    
      # #     pnpm config set registry https://registry.npmjs.org
      # #     pnpm config get registry

      # #     # #==============
      # #     # 编译

      # #     bash ${WORK_ROOT_DIR}/myutils/schoolmgr_schedule/scripts/build_server.sh $WORK_ROOT_DIR/.JENKINS.env || CheckLastResult
          
          
      # #     # 编译agent
      # #     bash ${WORK_ROOT_DIR}/myutils/schoolmgr_schedule/scripts/build_agent.sh $WORK_ROOT_DIR/.JENKINS.env || CheckLastResult
          
      # #     # 发布
      # #     bash ${WORK_ROOT_DIR}/myutils/schoolmgr_schedule/scripts/publish_server.sh $WORK_ROOT_DIR/.JENKINS.env || CheckLastResult
          
      # #     bash ${WORK_ROOT_DIR}/myutils/schoolmgr_schedule/scripts/publish_agent.sh $WORK_ROOT_DIR/.JENKINS.env || CheckLastResult

      

      # - name: publish action
      #   run: |
      #     pushd .
      #     cd ${UTILS_DIR}
      #     source utils.sh
      #     popd 
          
      #     bash ${WORKSPACE}/myutils/schoolmgr_schedule/scripts/publish_server.sh ${JENKINS_ENV_PATH} || CheckLastResult
          
      #     bash ${WORKSPACE}/myutils/schoolmgr_schedule/scripts/publish_agent.sh ${JENKINS_ENV_PATH} || CheckLastResult
      


      # - name: deploy action
      #   run: |
      #     pushd .
      #     cd ${UTILS_DIR}
      #     source utils.sh
      #     popd 
          
      #     # bash ${WORKSPACE}/myutils/schoolmgr_schedule/scripts/develop/deploy_web.sh ${JENKINS_ENV_PATH} || CheckLastResult
      #     bash ${WORKSPACE}/myutils/schoolmgr_schedule/scripts/guanlan/docker_deploy.sh  ${JENKINS_ENV_PATH} || CheckLastResult


      # - name: Setup SSH
      #   uses: webfactory/ssh-agent@v0.5.3
      #   with:
      #     ssh-private-key: ${{ secrets.SSH_KEY }}

          
      # - name: Cache SSH known hosts
      #   id: cache-ssh-hosts
      #   uses: actions/cache@v3
      #   with:
      #     path: ~/.ssh/known_hosts
      #     key: ssh-known-hosts-${{ runner.os }}-v1
      #     restore-keys: |
      #       ssh-known-hosts-${{ runner.os }}-


      # - name: Add Gitee ssh-key to known hosts
      #   shell: bash
      #   run: |
      #     mkdir -p $HOME/.ssh
      #     cat >$HOME/.ssh/known_hosts <<Eof
      #       gitee.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDMzG3r+88lWSDK9fyjcZmYsWGDBDmGoAasKMAmjoFloGt9HRQX2Qp4f9FY2XK/hsHYinvoh5Xytl9iaUNUWMfYR8q6VEMtOO87DgoAFcfKZHt0/nbAg9RoNTKYt6v8tPwYpr7N0JP/01nE4LFsNDnstr6H0bXSAzbKWCETLZfdPV4l2uSpRn3bU0ugoZ0aSKz5Dc/IloBfGCTvkSsxUydMRd/Chpjt6VxncDbp+Fa6pzsseK8OQzrg6Fgc5783EN3EQqZ2skqyCwExtx95BJlfx1B3luZnWfpkwNDnrZRT/Qx0OrWqyf0q6f9uQr+UG1S8qDcUn3e/9onq3rwBri8/
      #       gitee.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMuEoYdx6to5oxR60IWj8uoe1aI0X1fKOHWOtLqTg1tsLT1iFwXV5JmFjU46EzeMBV/6EmI1uaRI6HiEPtPtJHE=
      #       gitee.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEKxHSJ7084RmkJ4YdEi5tngynE8aZe2uEoVVsB/OvYN
      #     Eof
      
      # # - name: Add Gitee to known hosts
      # #   if: steps.cache-ssh-hosts.outputs.cache-hit != 'true'
      # #   shell: pwsh
      # #   run: |
      # #     New-Item -Path $HOME\.ssh -ItemType Directory -Force
      # #     #ssh-keyscan gitee.com >> $HOME\.ssh\known_hosts
      # #     ssh-keyscan github.com >> $HOME\.ssh\known_hosts
          
    
      # - uses: lukka/get-cmake@latest

      # - uses: actions/checkout@v3
      #   with:
      #     submodules: recursive

      # - name: show payload
      #   run: |
      #     echo "Client payload: ${{ toJson(github.event.client_payload) }}"
      # # - name: Set up Python
      # #   uses: actions/setup-python@v2
      # #   with:
      # #     python-version: '3.8'

      # - name: Install dding on non-Windows
      #   if: runner.os != 'Windows'
      #   run: |
      #     pip install dding
      #     mkdir -p ~/.dding
      #     dding_secret="${{ github.event.client_payload.dding_secret || env.DEFAULT_DDING_SECRET }}"
      #     dding_token="${{ github.event.client_payload.dding_token || env.DEFAULT_DDING_TOKEN }}"
      #     cat <<EOF > ~/.dding/config.json
      #     [
      #         {
      #             "group": "default",
      #             "secret": "$dding_secret",
      #             "token": "$dding_token"
      #         }
      #     ]
      #     EOF
      
      # - name: Install dding on Windows
      #   if: runner.os == 'Windows'
      #   shell: pwsh
      #   run: |
      #     pip install dding
      #     New-Item -Path $HOME\.dding -ItemType Directory -Force
      #     $dding_secret = "${{ github.event.client_payload.dding_secret || env.DEFAULT_DDING_SECRET }}"
      #     $dding_token = "${{ github.event.client_payload.dding_token || env.DEFAULT_DDING_TOKEN }}"
      #     $config = @"
      #     [
      #         {
      #             "group": "default",
      #             "secret": "$dding_secret",
      #             "token": "$dding_token"
      #         }
      #     ]
      #     "@
      #     $config | Out-File -FilePath $HOME\.dding\config.json -Encoding utf8
      # # - name: Set up proxy
      # #   run: |
      # #     git config --global http.proxy socks5://python:psdemo982@123.60.164.114:11654


      # - name: Clone repository from Gitee with trace
      #   shell: pwsh
      #   run: |
      #     # $env:GIT_TRACE = "1"
      #     git clone {{ github.event.client_payload.gitaddress }}
        
      #     # git clone git@gitee.com:charlesabc/quick-print.git
      #     # git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/charlesabc/quick-print.git 
      # - name: Setup MSBuild
      #   uses: microsoft/setup-msbuild@v2

      # - name: test cat
      #   shell: bash
      #   run: |
      #     set PYTHONIOENCODING=utf-8
      #     cd quick-print
      #     git log -n 5
      #     cat external\\common\\include\\wrapper_logger.h
          
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: install requirements
        shell: bash
        run: |
          set PYTHONIOENCODING=utf-8
          cd quick-print/tools/external_lib
          pip install -r requirements.txt

      # - name: Cache External Libraries
      #   id: cache-external-libs
      #   uses: actions/cache@v3
      #   with:
      #     path: quick-print/external
      #     key: ${{ runner.os }}-external-libs-${{ hashFiles('quick-print/tools/external_lib/libs.yaml', 'quick-print/tools/external_lib/download.py') }}
      #     restore-keys: |
      #       ${{ runner.os }}-external-libs-

      # - name: Set cache status environment variable
      #   shell: pwsh
      #   run: |
      #     if ("${{ steps.cache-external-libs.outputs.cache-hit }}" -eq "true") {
      #       echo "EXTERNAL_LIBS_CACHED=true" >> $env:GITHUB_ENV
      #       Write-Host "External libraries found in cache, skipping download"
      #     } else {
      #       echo "EXTERNAL_LIBS_CACHED=false" >> $env:GITHUB_ENV
      #       Write-Host "External libraries not in cache, will download"
      #     }

      - name: Download External Lib
        if: env.EXTERNAL_LIBS_CACHED != 'true'
        run: |
          set PYTHONIOENCODING=utf-8
          cd quick-print/tools/external_lib
          pip install -r requirements.txt
          python download.py --arch x64 --build_types dbg --mul
          python download.py --arch x64 --build_types rel --mul

          # 检查 download_freeimage.bat 是否存在，如果存在则执行
          if (Test-Path "download_freeimage.bat") {
            Write-Host "Found download_freeimage.bat, executing..."
            cmd /c "download_freeimage.bat"
          } else {
            Write-Host "download_freeimage.bat not found, skipping..."
          }
          
      - name: CMake
        shell: powershell
        run: |
          pwd
          dir 
          cd quick-print/build
          cmake ../ -G "Visual Studio 17 2022" -DENABLE_PLUGIN_OBFUSCATION=ON
          # run CMake (additional options like -DCMAKE_EXPORT_COMPILE_COMMANDS=TRUE are possible)
          # it is recommended to specify the compiler version used for the build
          # cmake -S . -B cbuild/ -DCRASHPAD_BUILD_EXAMPLES=TRUE -DCMAKE_CXX_COMPILER=cl.exe -DCMAKE_C_COMPILER=cl.exe -DCMAKE_BUILD_TYPE=Release
          # cmake --build cbuild/ --config Release -- /p:Configuration=Release
          
      - name: Build WebView
        run: |
          pwd
          dir 
          cd quick-print/WebView
          mkdir build
          cd build
          cmake ../ -DBUILD_WXWIDGETS_EXAMPLES=ON -DBUILD_WEBVIEW_EXAMPLES=ON -DBUILD_ADVANCED_WXWIDGETS_EXAMPLE=ON
          cmake --build .
      - name: Build Office
        run: |
          pwd 
          dir 
          cd quick-print/officeConvert
          mkdir build
          cd build
          cmake ../ BUILD_OFFICE_CONVERT_LIB=ON -DBUILD_TESTS=ON -DENABLE_GTEST=ON BUILD_OFFICE_CONVERT_DLL=ON BUILD_OFFICE_CONV_TOOL=ON BUILD_GUI_ASYNC_EXAMPLE=ON
          cmake --build .


      # - name: test cat1
      #   shell: bash
      #   run: |
      #     set PYTHONIOENCODING=utf-8
      #     cd quick-print
      #     git log -n 5
      #     cat external\\common\\include\\wrapper_logger.h
      #     git status
      #     git diff external/common/include/wrapper_logger.h

          
      - name: Build with MSBuild
        run: msbuild -m -t:Build -p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }} quick-print/build/quick-print.sln

      - name: Copy required DLLs to output directory
        shell: pwsh
        run: |
          # Define the output directory
          $outputDir = "quick-print\librel64"
          
          # Ensure output directory exists
          if (-not (Test-Path $outputDir)) {
            New-Item -ItemType Directory -Path $outputDir -Force
            Write-Host "Created output directory: $outputDir"
          }
          
          # Define required DLL files with their typical locations
          $systemDlls = @(
            @{Name="CRYPT32.dll"; Path="C:\Windows\System32\CRYPT32.dll"},
            @{Name="WS2_32.dll"; Path="C:\Windows\System32\WS2_32.dll"},
            @{Name="ADVAPI32.dll"; Path="C:\Windows\System32\ADVAPI32.dll"},
            @{Name="KERNEL32.dll"; Path="C:\Windows\System32\KERNEL32.dll"},
            @{Name="USER32.dll"; Path="C:\Windows\System32\USER32.dll"},
            @{Name="GDI32.dll"; Path="C:\Windows\System32\GDI32.dll"},
            @{Name="bcrypt.dll"; Path="C:\Windows\System32\bcrypt.dll"}
          )
          
          # Visual C++ Runtime DLLs - check multiple possible locations
          $vcRuntimePaths = @(
            "C:\Windows\System32",
            "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Redist\MSVC\*\x64\Microsoft.VC143.CRT",
            "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Redist\MSVC\*\x64\Microsoft.VC143.CRT"
          )
          
          $vcRuntimeDlls = @("MSVCP140.dll", "VCRUNTIME140.dll", "VCRUNTIME140_1.dll")
          
          # Universal CRT DLLs - check multiple possible locations
          $ucrtPaths = @(
            "C:\Windows\System32",
            "C:\Windows\SysWOW64", 
            "C:\Program Files (x86)\Windows Kits\10\Redist\ucrt\DLLs\x64",
            "C:\Program Files\Windows Kits\10\Redist\ucrt\DLLs\x64",
            "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Redist\MSVC\*\x64\Microsoft.VC143.CRT",
            "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Redist\MSVC\*\x64\Microsoft.VC143.CRT"
          )
          
          $ucrtDlls = @(
            "api-ms-win-crt-runtime-l1-1-0.dll",
            "api-ms-win-crt-string-l1-1-0.dll", 
            "api-ms-win-crt-stdio-l1-1-0.dll",
            "api-ms-win-crt-filesystem-l1-1-0.dll",
            "api-ms-win-crt-heap-l1-1-0.dll",
            "api-ms-win-crt-time-l1-1-0.dll",
            "api-ms-win-crt-math-l1-1-0.dll",
            "api-ms-win-crt-convert-l1-1-0.dll",
            "api-ms-win-crt-utility-l1-1-0.dll",
            "api-ms-win-crt-environment-l1-1-0.dll",
            "api-ms-win-crt-locale-l1-1-0.dll"
          )
          
          Write-Host "Copying system DLLs..."
          foreach ($dll in $systemDlls) {
            if (Test-Path $dll.Path) {
              Copy-Item $dll.Path $outputDir -Force
              Write-Host "Copied $($dll.Name)"
            } else {
              Write-Warning "$($dll.Name) not found at $($dll.Path)"
            }
          }
          
          Write-Host "Copying Visual C++ Runtime DLLs..."
          foreach ($vcDll in $vcRuntimeDlls) {
            $found = $false
            foreach ($path in $vcRuntimePaths) {
              $fullPath = Join-Path $path $vcDll
              $expandedPaths = Get-ChildItem $fullPath -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($expandedPaths) {
                Copy-Item $expandedPaths.FullName $outputDir -Force
                Write-Host "Copied $vcDll from $($expandedPaths.FullName)"
                $found = $true
                break
              }
            }
            if (-not $found) {
              Write-Warning "$vcDll not found in any of the expected locations"
            }
          }
          
          Write-Host "Copying Universal CRT DLLs..."
          foreach ($ucrtDll in $ucrtDlls) {
            $found = $false
            foreach ($path in $ucrtPaths) {
              $fullPath = Join-Path $path $ucrtDll
              # Handle wildcard paths for Visual Studio
              if ($fullPath -like "*\*\*") {
                $expandedPaths = Get-ChildItem $fullPath -ErrorAction SilentlyContinue | Select-Object -First 1
                if ($expandedPaths) {
                  Copy-Item $expandedPaths.FullName $outputDir -Force
                  Write-Host "Copied $ucrtDll from $($expandedPaths.FullName)"
                  $found = $true
                  break
                }
              } else {
                if (Test-Path $fullPath) {
                  Copy-Item $fullPath $outputDir -Force
                  Write-Host "Copied $ucrtDll from $fullPath"
                  $found = $true
                  break
                }
              }
            }
            if (-not $found) {
              Write-Warning "$ucrtDll not found in any of the expected locations - this may be normal on some Windows versions"
            }
          }
          
          Write-Host "DLL copy operation completed."

      - name: Inno Package
        shell: cmd
        run: |
          ls
          cd quick-print\setup\exe 
          if errorlevel 1 exit 1
          
          build.bat
          if errorlevel 1 exit 1
          
          build_update.bat 
          if errorlevel 1 exit 1
      - name: Inno update Package
        shell: cmd
        run: |
          ls
          cd quick-print\setup\exe || exit /b 1
          build_update.bat
          if errorlevel 1 exit 1
          
      - name: cp update to download server 
        shell: bash 
        run: |
          echo " copy to download server"
          ls
          cd quick-print/setup/exe 
          ls Output
          bash copy.sh
      - name: Check Status
        if: ${{ success() }}
        shell: pwsh
        run: |
          $repoName = $env:GITHUB_REPOSITORY.Split('/')[-1]
          Write-Host "Workflow succeeded for $repoName!"
          dding "github action success :) for $repoName"
          
      - name: Check Status
        if: ${{ failure() }}
        shell: pwsh
        run: |
          $repoName = $env:GITHUB_REPOSITORY.Split('/')[-1]
          Write-Host "Workflow failed for $repoName!"
          dding "github action fail :( $repoName"
      - name: Ls dir
        run: |
          echo "%cd%"
          dir
          cd quick-print
          dir 
          
      - name: Archive binaries
        uses: actions/upload-artifact@v4
        with:
          name: librel64
          path: |
            quick-print\librel64
          retention-days: 1 # <= 这里可以设置保留天数

      - name: Archive binaries
        uses: actions/upload-artifact@v4
        with:
          name: QuickPrintSetupArtifact
          path: |
            quick-print\setup\exe\Output\QuickPrintSetup.exe
            quick-print\setup\exe\Output\QuickPrintUpdateSetup.exe
          retention-days: 1 # <= 这里可以设置保留天数

      # - name: Archive binaries
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: QuickPrintSetupArtifact
      #     path: |
            
      #     retention-days: 1 # <= 这里可以设置保留天数


  create-release:
    runs-on: ubuntu-latest
    needs: msw-msvs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up environment
        run: echo "RELEASE_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Install GitHub CLI
        uses: sersoft-gmbh/setup-gh-cli-action@v2

      - name: Delete existing release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete $RELEASE_DATE --yes || true

      - name: Create new release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release create $RELEASE_DATE -t "Release $RELEASE_DATE" -n "Automated release for $RELEASE_DATE"


      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: zip Artifacts
        run: |
          ls ./artifacts
          cd ./artifacts
          rm -fr librel64/static
          rm -fr librel64/dll
          
          mv librel64 QuickPrintAll
          
          zip -r QuickPrintAll.zip QuickPrintAll
          
          # Create quick-print-tool.zip with tool and specific dll files
          mkdir -p quick-print-tool-package
          cp QuickPrintAll/quick-print-tool.exe quick-print-tool-package/ || echo "quick-print-tool.exe not found, skipping"
          cp -r QuickPrintAll/plugins quick-print-tool-package/ || echo "plugins not found, skipping"
          
          # Copy specific DLL files (these should now be in the QuickPrintAll directory from Windows build stage)
          declare -a required_dlls=(
            "CRYPT32.dll"
            "WS2_32.dll" 
            "ADVAPI32.dll"
            "KERNEL32.dll"
            "opencv_world4100.dll"
            "USER32.dll"
            "GDI32.dll"
            "MSVCP140.dll"
            "bcrypt.dll"
            "VCRUNTIME140.dll"
            "VCRUNTIME140_1.dll"
            "api-ms-win-crt-runtime-l1-1-0.dll"
            "api-ms-win-crt-string-l1-1-0.dll"
            "api-ms-win-crt-stdio-l1-1-0.dll"
            "api-ms-win-crt-filesystem-l1-1-0.dll"
            "api-ms-win-crt-heap-l1-1-0.dll"
            "api-ms-win-crt-time-l1-1-0.dll"
            "api-ms-win-crt-math-l1-1-0.dll"
            "api-ms-win-crt-convert-l1-1-0.dll"
            "api-ms-win-crt-utility-l1-1-0.dll"
            "api-ms-win-crt-environment-l1-1-0.dll"
            "api-ms-win-crt-locale-l1-1-0.dll"
          )
          
          echo "Copying required DLL files to quick-print-tool package..."
          for dll in "${required_dlls[@]}"; do
            if [ -f "QuickPrintAll/$dll" ]; then
              cp "QuickPrintAll/$dll" quick-print-tool-package/
              echo "✓ Copied $dll"
            else
              echo "⚠ Warning: $dll not found in QuickPrintAll/ (this may be expected for some DLLs)"
            fi
          done

          
          if [ -f "quick-print-tool-package/quick-print-tool.exe" ]; then
            cd quick-print-tool-package
            zip -r ../quick-print-tool.zip .
            cd ..
            echo "Created quick-print-tool.zip successfully"
          else
            echo "quick-print-tool.exe not found, skipping quick-print-tool.zip creation"
          fi
          
          
          
      - name: Generate MD5 Checksums
        run: |
          > ./artifacts/filelist.txt  # 清空或创建 filelist.txt 文件
          for file in ./artifacts/*.{zip,exe}; do
            # Calculate MD5 checksum
            md5sum=$(md5sum "$file" | awk '{ print $1 }')
      
            # Write to filelist.txt
            echo "$(basename "$file") | ${md5sum}" >> ./artifacts/filelist.txt
          done

      - name: Upload Artifacts to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ./artifacts
          gh release upload $RELEASE_DATE ./*.zip
          gh release upload $RELEASE_DATE ./QuickPrintSetupArtifact/*.exe
          gh release upload $RELEASE_DATE filelist.txt
          
      - name: LS Artifacts
        run: |
          ls 
          ls ./artifacts
  # dingding-error:
  #   runs-on: ubuntu-latest
  #   needs: [create-release]
  #   if: ${{ failure() }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Send dingding notify error
  #       uses: zcong1993/actions-ding@master
  #       with:
  #         dingToken: ${{ github.event.client_payload.dding_token.token }} | DEFAULT_DDING_TOKEN #钉钉token
  #         secret: ${{ github.event.client_payload.dding_token.secret }} | DEFAULT_DDING_SECRET
  #         body: |
  #           {
  #             "msgtype": "text",
  #             "text": {
  #                 "content": 'status:[打叉][打叉][打叉]  quick_print 执行失败\n提交者:  test\n${{ github.ref_type }}: master\nlog: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
  #            }
  #            }
            
  # dingding-success:
  #   runs-on: ubuntu-latest
  #   if: ${{ success() }}
  #   needs: [create-release]
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Send dingding notify success
  #       uses: zcong1993/actions-ding@master
  #       with:
  #         dingToken: ${{ github.event.client_payload.dding_token.token }} | DEFAULT_DDING_TOKEN #钉钉token
  #         secret: ${{ github.event.client_payload.dding_token.secret }} | DEFAULT_DDING_SECRET
  #         body: |
  #           {
  #            "msgtype": "text",
  #            "text": {
  #                "content": 'status:[对勾][对勾][对勾][100分]  quick_print 执行成功\n提交者: test\n${{ github.ref_type }}: master\nlog: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
  #            }
  #            }
