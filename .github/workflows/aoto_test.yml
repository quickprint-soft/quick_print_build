name: GTest CI/CD Pipeline

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-test:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - configuration: 'Release'
            platform: 'x64'
            vsversion: 2022
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive  # å¦‚æœæœ‰å­æ¨¡å—
        
    # - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
    #   uses: actions/setup-python@v5
    #   with:
    #     python-version: '3.11'
    #     cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–
        
    - name: ğŸ”§ é…ç½® MSVC ç¼–è¯‘å™¨
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: Clone repository from Gitee with trace
      shell: pwsh
      run: |
        git clone https://oauth2:${{ secrets.MYUSER_TOKEN }}@github.com/quickprint-soft/quick-print.git
        # git clone https://oauth2:${{ secrets.MYUSER_TOKEN }}@${{ github.event.client_payload.gitaddress }}
      
        # git clone git@gitee.com:charlesabc/quick-print.git
        # git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/charlesabc/quick-print.git 
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2


        
    - name: install requirements
      shell: bash
      run: |
        set PYTHONIOENCODING=utf-8
        cd quick-print/tools/external_lib
        pip install -r requirements.txt
    
    - name: Download External Lib
      run: |
        set PYTHONIOENCODING=utf-8
        cd quick-print/tools/external_lib
        pip install -r requirements.txt
        python download.py --arch x64 --build_types dbg --mul
        python download.py --arch x64 --build_types rel --mul
  
        # æ£€æŸ¥ download_freeimage.bat æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ‰§è¡Œ
        # if (Test-Path "download_freeimage.bat") {
        #   Write-Host "Found download_freeimage.bat, executing..."
        #   cmd /c "download_freeimage.bat"
        # } else {
        #   Write-Host "download_freeimage.bat not found, skipping..."
        # }
        
    # - name: ğŸ“¦ åˆ›å»ºæ„å»ºç›®å½•
    #   run: |
    #     if (Test-Path build) { Remove-Item -Recurse -Force build }
    #     mkdir quick-print/build
    #   shell: pwsh
        
    - name: âš™ï¸ é…ç½® CMake
      working-directory: quick-print/build
      run: cmake .. -G "Visual Studio 17 2022" -A x64
      
    # - name: ğŸ”¨ ç¼–è¯‘é¡¹ç›® (Release)
    #   working-directory: quick-print/build
    #   run: cmake --build . --target gtest_run --config Release --parallel

    - name: ğŸ”¨ Build WebView
      run: |
        pwd
        dir 
        cd quick-print/WebView
        mkdir build
        cd build
        cmake ../ -DBUILD_WXWIDGETS_EXAMPLES=ON -DBUILD_WEBVIEW_EXAMPLES=ON -DBUILD_ADVANCED_WXWIDGETS_EXAMPLE=ON
        cmake --build .
    - name: ğŸ”¨ Build Office
      run: |
        pwd 
        dir 
        cd quick-print/officeConvert
        mkdir build
        cd build
        cmake ../ BUILD_OFFICE_CONVERT_LIB=ON -DBUILD_TESTS=ON -DENABLE_GTEST=ON BUILD_OFFICE_CONVERT_DLL=ON BUILD_OFFICE_CONV_TOOL=ON BUILD_GUI_ASYNC_EXAMPLE=ON
        cmake --build .
    # - name: test cat1
    #   shell: bash
    #   run: |
    #     set PYTHONIOENCODING=utf-8
    #     cd quick-print
    #     git log -n 5
    #     cat external\\common\\include\\wrapper_logger.h
    #     git status
    #     git diff external/common/include/wrapper_logger.h

        
    - name: ğŸ”¨ Build with MSBuild
      run: msbuild -m -t:Build -p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }} quick-print/build/quick-print.sln
        
    - name: ğŸ“‚ å‡†å¤‡æµ‹è¯•æŠ¥å‘Šç›®å½•
      run: |
        if (Test-Path test_reports) { Remove-Item -Recurse -Force test_reports }
        mkdir test_reports
      shell: pwsh
        
    - name: ğŸ§ª è¿è¡Œ GTest æµ‹è¯•å¥—ä»¶
      working-directory: quick-print
      run: |
        $env:PATH += ";$PWD\librel64"
        .\librel64\gtest_run.exe --gtest_output=xml:test_reports/test_results.xml --gtest_print_time=1
        $testExitCode = $LASTEXITCODE
        echo "TEST_EXIT_CODE=$testExitCode" >> $env:GITHUB_ENV
        exit 0
      shell: pwsh
      continue-on-error: true
      
    - name: ğŸ“Š ç”Ÿæˆ HTML æµ‹è¯•æŠ¥å‘Š
      working-directory: quick-print/test-prj
        if: always()
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: "1"
        run: |
          chcp 65001 >NUL
          python -X utf8 generate_test_report.py -i ../test_reports/test_results.xml -o ../test_reports/test_report.html
        continue-on-error: true
        shell: pwsh
      
    - name: ğŸ“ ç”Ÿæˆæµ‹è¯•æ‘˜è¦
      if: always()
      run: |
        if (Test-Path test_reports/test_results.xml) {
          $xml = [xml](Get-Content test_reports/test_results.xml)
          $testsuites = $xml.testsuites
          $total = $testsuites.tests
          $failures = $testsuites.failures
          $errors = $testsuites.errors
          $time = $testsuites.time
          $passed = [int]$total - [int]$failures - [int]$errors
          $passRate = if ([int]$total -gt 0) { [math]::Round(($passed / [int]$total) * 100, 2) } else { 0 }
          
          echo "## ğŸ§ª GTest æµ‹è¯•ç»“æœ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ ‡ | æ•°å€¼ |" >> $env:GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| âœ… é€šè¿‡ | $passed / $total |" >> $env:GITHUB_STEP_SUMMARY
          echo "| âŒ å¤±è´¥ | $failures |" >> $env:GITHUB_STEP_SUMMARY
          echo "| âš ï¸ é”™è¯¯ | $errors |" >> $env:GITHUB_STEP_SUMMARY
          echo "| ğŸ“ˆ é€šè¿‡ç‡ | $passRate% |" >> $env:GITHUB_STEP_SUMMARY
          echo "| â±ï¸ æ€»è€—æ—¶ | $time ç§’ |" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          
          if ([int]$failures -gt 0 -or [int]$errors -gt 0) {
            echo "### âš ï¸ å­˜åœ¨å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ [æµ‹è¯•æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚" >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "### âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼" >> $env:GITHUB_STEP_SUMMARY
          }
        }
      shell: pwsh
      
    - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š (Artifacts)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ github.run_number }}
        path: |
          test_reports/test_results.xml
          test_reports/test_report.html
        retention-days: 30
        
    - name: ğŸ“Š å‘å¸ƒæµ‹è¯•ç»“æœåˆ° PR
      uses: EnricoMi/publish-unit-test-result-action/windows@v2
      if: always() && github.event_name == 'pull_request'
      with:
        files: test_reports/test_results.xml
        check_name: ğŸ§ª GTest æµ‹è¯•ç»“æœ
        comment_title: ğŸ“Š GTest æµ‹è¯•æŠ¥å‘Š
        comment_mode: always
        
    - name: âœ… æ£€æŸ¥æµ‹è¯•ç»“æœ
      if: always()
      run: |
        if ($env:TEST_EXIT_CODE -ne "0") {
          Write-Host "âŒ æµ‹è¯•å¤±è´¥ï¼é€€å‡ºç : $env:TEST_EXIT_CODE"
          exit 1
        } else {
          Write-Host "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
        }
      shell: pwsh
