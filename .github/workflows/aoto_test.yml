name: GTest CI with Reports

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ°æŒ‡å®šåˆ†æ”¯æ—¶è¿è¡Œ
  push:
    branches: 
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
  
  # Pull Request æ—¶è¿è¡Œ
  pull_request:
    branches: 
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'GTest è¿‡æ»¤å™¨ï¼ˆå¦‚: ImageToPdfTestSuite.*ï¼‰'
        required: false
        default: '*'
  
  # å®šæ—¶è¿è¡Œ
  schedule:
    # æ¯å¤©æ—©ä¸Š 9:00ï¼ˆåŒ—äº¬æ—¶é—´ = UTC 01:00ï¼‰
    - cron: '0 1 * * *'
    
    # å…¶ä»–å¸¸ç”¨æ—¶é—´é…ç½®ï¼ˆæ³¨é‡Šæ‰çš„å¯ä»¥æ ¹æ®éœ€è¦å¯ç”¨ï¼‰ï¼š
    # å·¥ä½œæ—¥æ—©ä¸Š 9:00
    # - cron: '0 1 * * 1-5'
    
    # æ¯å¤©æ—©ä¸Š 9:00 å’Œæ™šä¸Š 6:00
    # - cron: '0 1,10 * * *'
    
    # æ¯å‘¨ä¸€æ—©ä¸Š 9:00
    # - cron: '0 1 * * 1'
    
    # æ¯ 6 å°æ—¶ä¸€æ¬¡
    # - cron: '0 */6 * * *'

# ç¯å¢ƒå˜é‡
env:
  BUILD_TYPE: Release
  CMAKE_GENERATOR: "Visual Studio 17 2022"

jobs:
  test:
    name: è¿è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
    runs-on: windows-latest
    timeout-minutes: 60  # è¶…æ—¶ä¿æŠ¤
    
    # æƒé™é…ç½®
    permissions:
      contents: read
      pull-requests: write  # å…è®¸åœ¨ PR ä¸­æ·»åŠ è¯„è®º
      actions: read
    
    steps:
    # ========================================
    # 1. ç¯å¢ƒå‡†å¤‡
    # ========================================
    
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼ˆç”¨äºç‰ˆæœ¬ä¿¡æ¯ï¼‰
    
    - name: ğŸ”§ é…ç½® MSBuild
      uses: microsoft/setup-msbuild@v1.1
    
    - name: ğŸ“¦ é…ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–
    
    - name: ğŸ“š å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        # å¦‚æœæœ‰ requirements.txt å¯ä»¥åœ¨è¿™é‡Œå®‰è£…
        # pip install -r requirements.txt
    
    # ========================================
    # 2. æ„å»ºé¡¹ç›®
    # ========================================
    
    - name: ğŸ” æ£€æŸ¥ç¼“å­˜
      id: cache-build
      uses: actions/cache@v3
      with:
        path: |
          build
          external
        key: ${{ runner.os }}-build-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-build-
    
    - name: ğŸ—ï¸ é…ç½® CMake
      run: |
        cmake -B build -G "${{ env.CMAKE_GENERATOR }}" -A x64
    
    - name: ğŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: |
        cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
    
    # ========================================
    # 3. è¿è¡Œæµ‹è¯•
    # ========================================
    
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      id: test
      continue-on-error: true  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
      shell: bash
      run: |
        cd build/x64/${{ env.BUILD_TYPE }}
        
        # è®¾ç½®æµ‹è¯•è¿‡æ»¤å™¨
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.test_filter }}" ]; then
          TEST_FILTER="${{ github.event.inputs.test_filter }}"
          echo "ğŸ¯ ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨: $TEST_FILTER"
          ./gtest_run.exe --gtest_filter="$TEST_FILTER"
        elif [ "${{ github.event_name }}" == "schedule" ]; then
          echo "â° å®šæ—¶ä»»åŠ¡ï¼šè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶"
          ./gtest_run.exe
        else
          echo "ğŸ“ å¸¸è§„æµ‹è¯•è¿è¡Œ"
          ./gtest_run.exe
        fi
      
    - name: ğŸ“Š ç”Ÿæˆ HTML æŠ¥å‘Š
      if: always()
      run: |
        python test-prj/generate_html_report.py test-reports/test_report_latest.xml test-reports/test_report_latest.html
    
    - name: ğŸ“ˆ ç”Ÿæˆæµ‹è¯•æ‘˜è¦
      if: always()
      run: |
        python test-prj/generate_summary.py test-reports/test_report_latest.xml
    
    # ========================================
    # 4. ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
    # ========================================
    
    - name: ğŸ“¦ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šï¼ˆArtifactsï¼‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ github.run_number }}-${{ github.run_attempt }}
        path: |
          test-reports/*.xml
          test-reports/*.html
          test-reports/summary.txt
        retention-days: 30  # ä¿ç•™ 30 å¤©
        compression-level: 6  # å‹ç¼©çº§åˆ«ï¼ˆ0-9ï¼‰
    
    # ========================================
    # 5. å±•ç¤ºæµ‹è¯•ç»“æœ
    # ========================================
    
    - name: ğŸ“‹ æ·»åŠ æµ‹è¯•æ‘˜è¦åˆ° Actions Summary
      if: always()
      shell: bash
      run: |
        echo "## ğŸ§ª æµ‹è¯•æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ·»åŠ åŸºæœ¬ä¿¡æ¯
        echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**è¿è¡Œç¼–å·**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ·»åŠ æµ‹è¯•ç»“æœæ‘˜è¦
        if [ -f test-reports/summary.txt ]; then
          cat test-reports/summary.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•æ‘˜è¦æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“¥ [ä¸‹è½½å®Œæ•´æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
    
    # ========================================
    # 6. Pull Request è¯„è®º
    # ========================================
    
    - name: ğŸ’¬ åœ¨ PR ä¸­æ·»åŠ æµ‹è¯•ç»“æœè¯„è®º
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          // è¯»å–æµ‹è¯•æ‘˜è¦
          let summary = 'âš ï¸ æœªç”Ÿæˆæµ‹è¯•æŠ¥å‘Š';
          try {
            summary = fs.readFileSync('test-reports/summary.txt', 'utf8');
          } catch (error) {
            console.error('è¯»å–æ‘˜è¦æ–‡ä»¶å¤±è´¥:', error);
          }
          
          // æ„å»ºè¯„è®ºå†…å®¹
          const comment = `## ğŸ§ª æµ‹è¯•æŠ¥å‘Š
          
${summary}

---

ğŸ“Š **è¯¦ç»†ä¿¡æ¯**
- **è¿è¡Œç¼–å·**: #${{ github.run_number }}
- **è§¦å‘æäº¤**: \`${{ github.event.pull_request.head.sha }}\`
- **æµ‹è¯•çŠ¶æ€**: ${{ steps.test.outcome == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}

ğŸ“¥ [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Šå’Œæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

<sub>ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ</sub>`;
          
          // å‘å¸ƒè¯„è®º
          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            console.log('âœ… PR è¯„è®ºå·²å‘å¸ƒ');
          } catch (error) {
            console.error('âŒ å‘å¸ƒè¯„è®ºå¤±è´¥:', error);
          }
    
    # ========================================
    # 7. å¤±è´¥é€šçŸ¥ï¼ˆä»…å®šæ—¶ä»»åŠ¡ï¼‰
    # ========================================
    
    - name: ï¿½ å®šæ—¶ä»»åŠ¡å¤±è´¥é€šçŸ¥
      if: failure() && github.event_name == 'schedule'
      shell: bash
      run: |
        echo "âš ï¸ å®šæ—¶æµ‹è¯•å¤±è´¥ï¼"
        echo ""
        echo "ğŸ“… è¿è¡Œæ—¶é—´: $(date)"
        echo "ğŸ“Š æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ’¡ æç¤º: å¯ä»¥é…ç½®é‚®ä»¶æˆ– Slack é€šçŸ¥"
    
    # ========================================
    # 8. æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
    # ========================================
    
    - name: âœ… æ£€æŸ¥æµ‹è¯•ç»“æœ
      if: always()
      shell: bash
      run: |
        if [ "${{ steps.test.outcome }}" == "failure" ]; then
          echo "âŒ æµ‹è¯•å¤±è´¥ï¼"
          exit 1
        elif [ "${{ steps.test.outcome }}" == "success" ]; then
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
          exit 0
        else
          echo "âš ï¸ æµ‹è¯•çŠ¶æ€æœªçŸ¥"
          exit 1
        fi
